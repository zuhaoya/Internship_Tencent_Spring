### Tars框架笔记

---

#### 微服务架构

> 早期的软件工程 单体架构（所有后台功能高度耦合在一起）
>
> ![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-1292f5a391142ac8da195787e28291bf_720w.jpg)
>
> 显然这里会出现很多问题：
>
> * 业务逻辑代码高度重复
> * 接口调用混乱
> * 应用边界模糊，功能归属混乱
> * 数据库瓶颈 
> * 后续开发、测试、部署、维护困难
> * 。。。

所以，我们需要一个梳理整体架构，抽象出公用的业务服务代码

![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-0882bc64f3f20939876d3433e51fad72_720w.jpg)

显然，服务分开了，但是数据库的瓶颈依然存在。

* 数据库仍然为性能瓶颈 
* 数据管理趋向混乱
* 数据库表结构会被多个服务依赖，牵一发而动全身

所以，我们还需要拆分数据库

![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-90388920d31fe35b791c6a92f758db18_720w.jpg)

但是即使是微服务架构，依然存在自己的问题。

* **微服务架构整个应用分散成多个服务，定位故障点非常困难**
* **稳定性下降，一个服务故障可能导致整个系统挂掉**
* 服务数量众多，部署、管理工作量太大
* 无法保证服务在持续开发的情况下，仍可以协同合作
* 测试复杂

所以我们需要一系列的服务。

**监控：发现故障的征兆**

首先，我们需要进一步建立完善的监控体系，但是很难写一个很大的服务来监控每个服务（每个服务需要监控的内容不大相同），于是，我们需要让各个组即服务自己提供报告自己当前状态的接口，然后通过部署指标采集器，获得这些状态。

![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-ab2479317923472e06d5f3e0b8943944_720w.jpg)

**定位服务 - 链路跟踪**

在微服务架构下，一个用户的请求往往涉及多个内部服务调用。为了方便定位问题，需要能够记录每个用户请求时，微服务内部产生了多少服务调用，及其调用关系。这个叫做链路跟踪。

**分析问题：日志分析**

日志分析组件应该在微服务兴起之前就被广泛使用了。即使单体应用架构，当访问数变大、或服务器规模增多时，日志文件的大小会膨胀到难以用文本编辑器进行访问，更糟的是它们分散在多台服务器上面。排查一个问题，需要登录到各台服务器去获取日志文件，一个一个地查找（而且打开、查找都很慢）想要的日志信息。

**网关：权限控制，服务治理**

在调用者和被调用者中间加一层网关，每次调用时进行权限校验。另外，网关也可以作为一个提供服务接口文档的平台

![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-84a6eee84a5dc3f2e97f56b4148bbc66_720w.jpg)

**服务注册于发现 - 动态扩容**

对于故障的处理，最粗暴也是最直接的方法是冗余，同个服务器部署多个实例。

新增实例的操作：部署新实例，将新实例注册到负载均衡/DNS上

![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-5b0fea85e31caa7b6ed88cb6fbdf5005_720w.jpg)

**熔断、服务降级、限流**

熔断：

当一个服务因为各种原因停止响应时，调用方通常会等待一段时间，然后超时或者收到错误返回。如果调用链路比较长，可能会导致请求堆积，整条链路占用大量资源一直在等待下游响应。所以当多次访问一个服务失败时，应熔断，标记该服务已停止工作，直接返回错误。直至该服务恢复正常后再重新建立连接。

服务降级：

当下游服务停止工作后，如果该服务并非核心业务，则上游服务应该降级，以保证核心业务不中断。比如网上超市下单界面有一个推荐商品凑单的功能，当推荐模块挂了后，下单功能不能一起挂掉，只需要暂时关闭推荐功能即可。

限流：

一个服务挂掉后，上游服务或者用户一般会习惯性地重试访问。这导致一旦服务恢复正常，很可能因为瞬间网络流量过大又立刻挂掉，在棺材里重复着仰卧起坐。因此服务需要能够自我保护——限流。限流策略有很多，最简单的比如当单位时间内请求数过多时，丢弃多余的请求。另外，也可以考虑分区限流。仅拒绝来自产生大量请求的服务的请求。例如商品服务和订单服务都需要访问促销服务，商品服务由于代码问题发起了大量请求，促销服务则只限制来自商品服务的请求，来自订单服务的请求则正常响应。

测试：

1. 端到端测试：覆盖整个系统，一般在用户界面机型测试。
2. 服务测试：针对服务接口进行测试。
3. 单元测试：针对代码单元进行测试。

![img](D:\zuhaoya\Internship_Tencent_Spring\tars框架学习\图片\v2-7da95a84f6c0dfd889ceb96acdf98b88_720w.jpg)



**微服务框架**

指标接口、链路跟踪注入、日志引流、服务注册发现、路由规则等组件以及熔断、限流等功能都需要在应用服务上添加一些对接代码。如果让每个应用服务自己实现是非常耗时耗力的。基于DRY的原则，小明开发了一套微服务框架，将与各个组件对接的代码和另外一些公共代码抽离到框架中，所有的应用服务都统一使用这套框架进行开发。

使用微服务框架可以实现很多自定义的功能。甚至可以将程序调用堆栈信息注入到链路跟踪，实现代码级别的链路跟踪。或者输出线程池、连接池的状态信息，实时监控服务底层状态。

使用统一的微服务框架有一个比较严重的问题：框架更新成本很高。每次框架升级，都需要所有应用服务配合升级。当然，一般会使用兼容方案，留出一段并行时间等待所有应用服务升级。但是如果应用服务非常多时，升级时间可能会非常漫长。并且有一些很稳定几乎不更新的应用服务，其负责人可能会拒绝升级……因此，使用统一微服务框架需要完善的版本管理方法和开发管理规范

